<li id="ledger-post-<%= ledger_post.id %>" class="row">
<% if !ledger_post.allowed_to_view?(current_ledger_user) %>
  <div class="col-xs-12 not-allowed-to-view">
    <%= "#{ledger_post.base_s} You don't have permission to view this object." %>
  </div>
<% else
  if ledger_post.respond_to? :path
    indent = ledger_post.path.count(",")
  else
    indent = 0
  end
  indent = 15 * indent
  %>
  <div class="col-xs-12">
    <div class="post-gravatar-box" style="margin-left: <%= indent %>px;">
      <%= # Will need the label style this user prefers, for several things.
        label_style = current_user&.fancy_labels
        label_style = 0 if label_style.nil? || label_style < 0
        label_style = 2 if label_style > 2

        # Update points since they're being shown.  Affects expiry time too.
        points_object = ledger_post.update_current_points

        highest_points = points_object.current_up_points
        highest_points = points_object.current_meh_points if
          points_object.current_meh_points > highest_points
        highest_points = points_object.current_down_points if
          points_object.current_down_points > highest_points

        # Note we are showing the creator of this particular version of the
        # post, not the original or current creator.  Nil if User deleted.
        creator_user = ledger_post.creator.user
        if creator_user
          (link_to gravatar_for(creator_user, size: 50), creator_user) + " " +
          (link_to ledger_post.creator.latest_version.name, creator_user)
        else # No User record (deleted?), just display the Ledger name.
          ledger_post.creator.latest_version.name
        end %><br>
      <%= render 'ledger_bases/timestamp_plain',
        { ledger_object: ledger_post } %><br>
      <%= # Reply icon and number of replies; icon is link to do a reply,
        # count is a link to show a tree of all replies. 
        link_to ApplicationHelper::DIRECTION_LABELS["R"][label_style],
          reply_ledger_post_path(ledger_post) %> <%=
          link_to format("%d", ledger_post.reply_count),
          descendants_ledger_post_path(ledger_post) %>&nbsp; <%=
        # Quote icon and number of quotes, bpth are links to things.
        link_to ApplicationHelper::DIRECTION_LABELS["Q"][label_style],
          quote_ledger_post_path(ledger_post) %> <%=
          link_to format("%d", ledger_post.quote_count),
          ancestors_ledger_post_path(ledger_post) %><br>
      <%= # List the rating for this post, up / meh / down.  Also clicking on a
        # particular direction will do a Like/Meh/Dislike on the post and its
        # author, for a default number of points.  There's a separate option
        # in the details view for creating a more nuanced LinkOpinion.
        # Buttons change colour to show the direction with the highest
        # number of points.  Default is washed out btn-info, highlights are
        # green=Up=btn-success, purple=Meh=btn-primary, red=Down=btn-danger.
        form_with(url: link_opinions_path, local: true, method: :post,
          class: "button-inline") do |f| %>
          <%= f.hidden_field :opinion_about_object_id, value: ledger_post.id %>
          <%= f.hidden_field :author_id,
            value: ledger_post.creator.original_version_id %>
          <%= f.hidden_field :reason_why,
            value: "Up button pressed for #{ledger_post}." %>
          <%= f.submit ApplicationHelper::DIRECTION_LABELS["U"][label_style] +
            format("%.2f", points_object.current_up_points), name: "U",
            class: "btn btn-" +
              ((points_object.current_up_points < highest_points) ? "info" :
              "success") %>
        <% end %>
        <%= form_with(url: link_opinions_path, local: true, method: :post,
          class: "button-inline") do |f| %>
          <%= f.hidden_field :opinion_about_object_id, value: ledger_post.id %>
          <%= f.hidden_field :author_id,
            value: ledger_post.creator.original_version_id %>
          <%= f.hidden_field :reason_why,
            value: "Meh button pressed for #{ledger_post}." %>
          <%= f.submit ApplicationHelper::DIRECTION_LABELS["M"][label_style] +
            format("%.2f", points_object.current_meh_points), name: "M",
            class: "btn btn-" +
              ((points_object.current_meh_points < highest_points) ? "info" :
              "primary") %>
        <% end %>
        <%= form_with(url: link_opinions_path, local: true, method: :post,
          class: "button-inline") do |f| %>
          <%= f.hidden_field :opinion_about_object_id, value: ledger_post.id %>
          <%= f.hidden_field :author_id,
            value: ledger_post.creator.original_version_id %>
          <%= f.hidden_field :reason_why,
            value: "Down button pressed for #{ledger_post}." %>
          <%= f.submit ApplicationHelper::DIRECTION_LABELS["D"][label_style] +
            format("%.2f", points_object.current_down_points), name: "D",
            class: "btn btn-" +
              ((points_object.current_down_points < highest_points) ? "info" :
              "danger") %>
        <% end %>
    </div>
    <%= render "ledger_posts/ledger_post_plain",
      { ledger_post: ledger_post } %>
  </div>
<% end %>
</li>

