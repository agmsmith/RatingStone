head	1.11;
access;
symbols;
locks; strict;
comment	@# @;


1.11
date	2020.02.04.22.20.21;	author agmsmith;	state Exp;
branches;
next	1.10;

1.10
date	2020.02.03.22.33.40;	author agmsmith;	state Exp;
branches;
next	1.9;

1.9
date	2020.02.03.22.26.20;	author agmsmith;	state Exp;
branches;
next	1.8;

1.8
date	2020.02.02.22.15.24;	author agmsmith;	state Exp;
branches;
next	1.7;

1.7
date	2020.02.02.21.44.52;	author agmsmith;	state Exp;
branches;
next	1.6;

1.6
date	2020.01.31.21.54.25;	author agmsmith;	state Exp;
branches;
next	1.5;

1.5
date	2020.01.30.22.16.28;	author agmsmith;	state Exp;
branches;
next	1.4;

1.4
date	2020.01.30.15.45.39;	author agmsmith;	state Exp;
branches;
next	1.3;

1.3
date	2020.01.30.14.40.09;	author agmsmith;	state Exp;
branches;
next	1.2;

1.2
date	2020.01.29.22.52.13;	author agmsmith;	state Exp;
branches;
next	1.1;

1.1
date	2020.01.29.22.43.07;	author agmsmith;	state Exp;
branches;
next	;


desc
@Documenting the Rating Stone database design, and related classes.
@


1.11
log
@Proof reading pass done.  Also added list design choices.
@
text
@# The Rating Stone Reputation System Database

<SMALL>$Id: Database\040Design.md,v 1.10 2020/02/03 22:33:40 agmsmith Exp agmsmith $</SMALL>

## Basic Ideas

Because I'm thinking someone could implement the reputation system as a
BlockChain ledger application, or as a federated collection of systems
exchanging records, the database is set up as a write once collection of object
records and link records.  Objects are the things the user can view and they
have ratings (posted messages, lists of things, other users).  Links implement
lists of things, connecting a pair of objects together, one being a parent or
container object (such as a list of book reviews) and the other being a child
object now in that container (such as a book review object).  Usually rating
points are also transfered when you create a link (perhaps describing how much
you like that book review).

### Changing Things by Making New Objects

For example, if you want to edit some posted text, the system will create a
newer object (they all have datestamps) with the new text and a reference back
to the original text object record.  Then when displaying the original text, it
will search for newer versions and display that text instead.  But new
references (links) to the text will still point at the original text record,
since that has a more constant identity then possibly yet more new text
records.  Of course, advanced users can view a list of all those text records
and see the change history.

Similarly when someone adds an item to a list, a link record will be added to
connect the list and the item.  To remove an item, the link record isn't
deleted, instead a new unlink record is created, referencing the original link
record.

Theoretically, when displaying the current state of things, you run through all
the records in chronological order, adding and removing objects and links from
the current state.  In practice, we cache things.  So an object record would
have a flag that marks it as deleted or amended, and a link record would
similarly be marked, and there can be cached forward references to more quickly
point out the record with the latest change.

### Single Table Inheritance

Because I don't want to have zillions of tables, and want to inherit
functionality for various related record types (generic object > text object >
book review object), we're using the Ruby on Rails ActiveRecord "[single table
inheritance](https://api.rubyonrails.org/classes/ActiveRecord/Inheritance.html)"
setup.  There will be one actual database table for objects and another one for
links, both have a "type" field in each row to specify the particular subclass
used for that row.

#### Reusing Generic Fields to Avoid Space Explosion

To avoid the common complaint about single table inheritance adding too many
fields for subclasses, we put some generic number and string fields into the
base class and reuse them differently for each subclass.  Subclasses give those
generic fields subclass-specific names by using the magic "alias_attribute"
ActiveRecord function.  So where the base may have a generic string1 and
string2 field, a User subclass could rename those as FullName and EMailAddress,
with "alias_attribute :full_name, :string1" and "alias_attribute
:email_address, :string2".  ActiveRecord will then automatically build queries
using the actual database field (string1, string2) names whenever we use the
subclass object.

### Direct References, Link Records, or Full Blown Lists

There's a design choice needed on making lists of things.  Should you make link
records between a main object and sub-objects that apply to it, or should you
have a second object as kind of a list header, and link the sub-objects to it?
For example, a Friends list.  You could link friends (LedgerUser records) to
the main user (another LedgerUser record) with specialised link_friend records.
Or you could make a LedgerListFriends object with a link to the main user, then
attach the friends to that with generic link records.

#### Design Choice - Faster

Direct links are faster for the database, but need a lot of custom link record
subclasses.  The list header method just needs to give the list header a name
and uses generic records, but requires more database operations.  There's also
a third option of putting the link reference in the record as an id field, like
friend_id, but that only works if you have one friend (useful in other cases,
like having only one creator).  We'll go with the faster but more work custom
link subclasses method, except for user defined lists which will use the list
header with a name technique.  And plain references where that makes sense.


## *LedgerBase*

The base class for persistent objects that the user may interact with.  There
is one database table for all objects of this class and subclasses.

* id The usual big (64 bit) integer unique record sequence number, which
  identifies the record/object.  There's an index of course to make finding a
  record by id number quick.  In the future we may use a GUID instead, or a
  pair of (id,server) if there are several federated servers run by different
  organisations.  Write-once.
* type string The name of the subclass to use for this object record.
  Write-once.
* creator_id Identifies the user who created this record.  Never NULL; the root
  user is considered to have created themself.  Write-once.
* original_id Points to the original version of this record, or NULL if this is
  the original one.  When someone creates a link to the object, by default it's
  linked to by the original id.  The original record is still used to cache the
  rating points and other dyanmic things, though the actual content (text in a
  Post for example) comes from the latest amended record (unless the user is
  looking for a specific version the object).  Happens to be write-once.
* amended_id Points to the latest version of this record, or NULL if this is
  not the original record.  Changed as needed.
* deleted_id Points to one of the LedgerDelete records that is currently
  deleting this record, otherwise NULL (record is alive).  Deleted records just
  show a warning message to the user when an attempt is made to display this
  object.  Rating points are accumulated as usual.  That way we can undelete
  this record if needed.  Changed as needed.
* current_down_points float  Changed as needed.
* current_meh_points float  Changed as needed.
* current_up_points float Changed as needed.  Number of rating points in each
  of the directions for this object.  This is the current total, including
  fading over time (recalculated at the beginning of the week in the awards
  ceremony) plus new ratings applied this week.  We keep the directions seprate
  to improve statistical estimation of how accurate the rating is (just storing
  the net difference of 2 points isn't as meaningful as knowing you had 102 up
  and 100 down vs 3 up and 1 down), and use them as inputs to various different
  sorting algorithms.  Until someone redoes the statistical theory, we'll split
  meh points 50% to each of up and down.  But once we have better math, we can
  use meh directly.  When they have all faded away to close to zero (less than
  0.01, equivalent to 3 years of fading one point) then the record can be
  deleted from the current database, freeing up storage.

### *LedgerDelete* < LedgerBase

Used for marking possibly multiple objects as deleted or killed.  LinkDelChild
records are used to associate this LedgerDelete with all the objects being
deleted.  Undelete is implemented by creating a new LedgerDelete record to kill
the original LedgerDelete record, repeat as needed to redelete and so on.  We
don't support, or even want to think about having a LedgerDelete delete itself.
Can have several LedgerDelete records deleting the same object; need to kill
all those LedgerDelete records to undelete that object.

* unlink_too boolean True if the links to the object (those where LinkBase
  child_id points to the deleted object) are deleted too (removing it from all
  lists), false if just the object is deleted.  This flag is ignored when
  deleting a LedgerDelete record - all associated links and objects are updated
  recursively.


### *LedgerUnlink* < LedgerBase

Breaks a link, used for removing an object from a list.  You can undo an unlink
by deleting this LedgerUnlink object.

* link_id Which LinkBase object to mark as deleted.


### *LedgerUser* < LedgerBase

Idenfities a particular user.

* User_id Points to a user's record in the separate Users database (see
  RailsTutorial) which has passwords, e-mail addresses and other private
  information.
* Elsewhere, the user is referenced by the record id number of the LedgerUser
  record.  Though for export or federated systems we'd need a GUID or an
  id+server pair.
* Points gained per week cached value.  Computed by considering various award
  records (such as e-mail verified, passport photo uploaded, had tea with the
  sysop, bought some bonus points) attached to the LedgerUser record by links.


### *LedgerMicropost* < LedgerBase

A micropost made by a user.  Contains some text in UTF-8 markdown format.  They
can also attach pictures and other media files.  There can also be micropost
replies, the micropost can be placed in a category list to identify what the
topic of the text is, have rating points awarded to it, and so on.  This is the
object the user interacts with the most.  It is also usually visible to users
and even external web sites, unless permissions make it private.

* content Text for the micropost.  Length limited only by the number of points
  the user wants to spend.


### *LedgerMedia* < LedgerBase

A file uploaded by the user.  Usually some sort of media, like a picture or
video clip.  Can be attached to microposts to make them more interesting, and
referenced by external web sites as well.  Byte size only limited by the points
the user wants to spend to upload it.  All kinds can display a picture, which
can be clicked on to get more detail or play it if it is a video or audio file.

* Implicit ActiveStorage link stores the file.  Have functions for getting the
  file size, data type, URL, etc.


### *LedgerAwardCeremony* < LedgerBase

This record marks the time when (usually weekly) rating points are awarded.  We
perform the ceremony relative to planetary time, so the actual time between
ceremonies won't always be exactly 7 days and 0 seconds, due to the slowdown of
the earth's rotation.  If you delete this record, the ceremony is ignored and
just about everything needs to be recalculated, including award numbers for
subsequent ceremonies and LinkBase records.  Currently deleting this kind of
record is not implemented, so don't do it.

* award_number A count of the number of award ceremonies done up to and
  including this one.  In other words, a seqeunce counter starting at 1.  So if
  rating points were assigned at the beginning of time, before any awards, the
  faded value of the points after a particular award ceremony would be original
  points * (fade ** award_number).
* completed_at Time stamp for when the award ceremony was completed.  The start
  time is in the usual created_at time stamp for this record.


### *LedgerBirthday* < LedgerBase

Identifies the birthday of a user.  Mostly an excuse to reuse the generic
timestamp field that LedgerAwardCeremony made necessary.

* birthday_at Date and time stamp of when the user was born, or first became
  independently operational.


### *LedgerPermissions* < LedgerBase

Specifies the permissions needed to access the LedgerObject this record is
linked to via LinkPermission.  There is a list or even a subtree linked to this
record specifying a bunch of users in some way (friends of friends etc), as
specifed by the link record type.  Often this will be a discussion group list.
There can be several LedgerPermissions records attached to the same object,
they are applied in chronological order of link created dates until a decision
is made.  A LedgerPermissions record can be shared between several objects too,
such as a default permission for a discussion group applying to all microposts
and replies in the group.

* present_permission char Has "N" to prohibit the listed users from accessing
  the object, "R" to allow only read access, "L" to allow link creation access
  too (adding a micropost to your own list), "W" to allow write access too
  (writing replies, effectively adding a link to the micropost), "A" to add
  amending and deleting access, "I" to inherit permissions from a later
  permission record ("I" could also be thought to mean ignore).
* absent_permission char Same letter codes, but apply to users NOT listed.


## *LinkBase*

The base class for links of all kinds between pairs of objects.  There is one
database table for all objects of this class and subclasses.  The particular
subclass identifies what the link's purpose is (object A owns object B, object
A is a list header and B is in the list, etc).

* id The usual big (64 bit) integer unique record sequence number so that we
  can refer to the link record,  only explicitly used by LedgerUnlink.
* type string The name of the subclass to use for this object record.
* parent_id Points to the LedgerBase object (or subclass) which is usually the
  main one in the association.  Never NULL.
* child_id Points to the LedgerBase object (or subclass) which is the other one
  in the association.  Never NULL.
* creator_id Identifies the User who created this link.  Never NULL.
* deleted_id Points to one of the LedgerUnlink or LedgerDelete records that
  deleted this record, otherwise NULL (this record is alive).  If this record
  is deleted, the link it made is considered to not exist any more.  Any rating
  points gained by that object through the link vanish, as if they never were
  transfered.  However, the rating points spent by the user to make the link
  are not returned to the user (otherwise they could temporarily transfer
  points and someone else could spend more than they are allowed).  Can
  undelete by deleting the LedgerUnlink or LedgerDelete, another good reason
  for keeping the rating points spent.
* rating_points_spent float The number of points spent on making this link by
  the creator, including transaction fees (larger fees for storing more bytes
  and a base fee to avoid high speed trading problems).
* rating_points_boost float The number of points used to boost the rating of
  the child object, equals spent minus fees.  Over time they are considered to
  fade (the value in the database doesn't change, we just calculate the current
  faded value when needed), and when enough time has gone by, you can remove
  this link completely from the database.  If the child object no longer has
  any points, it can be deleted too, and so on.  We'll probably do that as part
  of the weekly point updates - if the total is near zero (under 0.01, about 3
  years of fading for one point), the link or object can be deleted.
* rating_direction char How the points from the creator are applied to the
  child object, can be "U" for up, "D" for down or "M" for meh.
* award_number The week's award number when this record was created, 0 if
  before any ceremonies have been done.  Lets us easily calculate the current
  faded value of the rating points.  This field can be recalculated by looking
  at this record's created_at date and cross referencing with all the undeleted
  LedgerAwardCeremony records.


### *LinkDelChild* < LinkBase

Identifies an object to be deleted, for use with LedgerDelete.  Parent is the
LedgerDelete record, child is one of the objects being deleted.  If this
LinkDelChild object is deleted, then the LedgerDelete operation is modified to
not include the child.


### *LinkReply* < LinkBase

The child is a reply to the parent.  Usually both objects are LedgerMicropost.


### *LinkMedia* < LinkBase

The child is some sort of media which should be displayed when the parent is
shown.  Usually the parent is a LedgerMicropost and the child is a LedgerMedia
of some type.  We just treat them all as pictures and show them in a grid after
the text of the micropost.  The user can click on individual ones to play them.


### *LinkPermission* < LinkBase

The parent is some LedgerObject, the child is a LedgerPermissions record that
applies to the parent.  If there are several LinkPermission records for the
same parent object, they are run through in increasing date of link creation
until a permission decision is made.


## Generating the Database

Here are the rails command lines and edits needed to generate the database:

<PRE>rails generate model LedgerBase type:string
bool1:boolean date1:datetime number1:integer string1:string string2:string
text1:text creator:references original:references amended:references
deleted:references ledger1:references
current_down_points:float current_meh_points:float current_up_points:float</PRE>

Edit the migration file to have default values like this:

<PRE>class CreateLedgerBases < ActiveRecord::Migration[6.0]
  def change
    create_table :ledger_bases, force: false, comment: "Ledger objects base class and record.  Don't force: cascade deletes since it is a write-once ledger." do |t|
      t.string :type, default: "LedgerBase", comment: "Names the ActiveRecord subclass used to load this row."
      t.boolean :bool1, default: false, comment: "Generic boolean, defined by subclasses."
      t.datetime :date1, default: DateTime.new(1,1,1,0,0,0), comment: "Generic date and time from year 0 to year 9999, defined by subclasses."
      t.integer :number1, default: 0, comment: "Generic number for counting things, defined by subclasses."
      t.string :string1, default: "", comment: "Generic string (up to 255 bytes), defined by subclasses."
      t.string :string2, default: "", comment: "Generic string (up to 255 bytes), defined by subclasses."
      t.text :text1, default: "", comment: "Generic text (lots of characters), defined by subclasses."
      t.references :creator, null: false, foreign_key: {to_table: :ledger_bases, name: "fk_rails_ledgercreator"}, comment: "Identifies the user who created this record."
      t.references :original, null: true, foreign_key: {to_table: :ledger_bases, name: "fk_rails_ledgeroriginal"}, comment: "Points to the original version of this record, or NULL if this is the original one."
      t.references :amended, null: true, foreign_key: {to_table: :ledger_bases, name: "fk_rails_ledgeramended"}, comment: "Points to the latest version of this record, or NULL if this is not the original record."
      t.references :deleted, null: true, foreign_key: {to_table: :ledger_bases, name: "fk_rails_ledgerdeleted"}, comment: "Points to one of the LedgerDelete records that is currently deleting this record, otherwise NULL (record is alive)."
      t.references :ledger1, null: true, foreign_key: {to_table: :ledger_bases, name: "fk_rails_ledger1"}, comment: "Generic reference to some other LedgerBase record, can be NULL, defined by subclasses."
      t.float :current_down_points, default: 0.0
      t.float :current_meh_points, default: 0.0
      t.float :current_up_points, default: 0.0
      t.timestamps
    end
  end
end</PRE>

In ledger_base.rb:
<PRE>
  has_many :link_downs, class_name: :LinkBase, foreign_key: :parent_id
  has_many :descendants, through: :link_downs, source: :child
  has_many :link_ups, class_name: :LinkBase, foreign_key: :child_id
  has_many :ancestors, through: :link_ups, source: :parent
</PRE>

Then make the LinkBase object / record:

<PRE>rails generate model LinkBase type:string
parent:references child:references creator:references deleted:references
rating_points:float rating_direction:string award_number:integer</PRE>

<PRE>class CreateLinkBases < ActiveRecord::Migration[6.0]
  def change
    create_table :link_bases, force: false, comment: "LinkBase base class and record for linking LedgerObjects together." do |t|
      t.string :type, default: "LinkBase", comment: "Names the ActiveRecord subclass used to load this row."
      t.references :parent, null: false, foreign_key: {to_table: :ledger_bases, name: "fk_rails_linkparent"}, comment: "Points to the LedgerBase object (or subclass) which is usually the main one in the association."
      t.references :child, null: false, foreign_key: {to_table: :ledger_bases, name: "fk_rails_linkchild"}, comment: "Points to the LedgerBase object (or subclass) which is the other one in the association."
      t.references :creator, null: false, foreign_key: {to_table: :ledger_bases, name: "fk_rails_linkcreator"}, comment: "Identifies the User who created this link."
      t.references :deleted, null: true, foreign_key: {to_table: :ledger_bases, name: "fk_rails_linkdeleted"}, comment: "Points to one of the LedgerUnlink or LedgerDelete records that deleted this record, otherwise NULL (this record is alive)."
      t.float :rating_points_spent, default: 0.0, comment: "The number of points spent on making this link by the creator."
      t.float :rating_points_boost, default: 0.0, comment: "The number of points used to boost the rating of the child object."
      t.string :rating_direction, default: "M", comment: "Use U for up, D for down or M for meh."
      t.integer :award_number, default: 0, comment: "The week's award number when this record was created, 0 if before time starts."
      t.timestamps
    end
  end
end</PRE>

In link_base.rb add:
<PRE>
  belongs_to :parent, class_name: :LedgerBase, optional: false
  belongs_to :child, class_name: :LedgerBase, optional: false
</PRE>

Then add the LinkBase reference field in the LedgerBase record:

<PRE>rails generate migration AddLink1ToLedgerBase link1:references:index</PRE>

<PRE>class AddLink1ToLedgerBase < ActiveRecord::Migration[6.0]
  def change
    add_reference :ledger_bases, :link1, null: true, foreign_key: {to_table: :link_bases, name: "fk_rails_ledgerlink1"}, comment: "Points to a generic LinkBase object (or subclass)."
  end
end</PRE>


## Test Plan - A few Use Cases

A new user writes a message.  Another user replies to it.  First user edits
their message.  What does second user see?  First user replies to second user's
message.  First user deletes their original message.

A user adds some photos and videos to a message.  They are separate objects,
and need the expendature of rating points to be attached (more points are
required for a larger number of bytes).  What happens when they run out of
points?  Do they get attached to the message and show up when it is displayed?

First user sets up a small category tree and adds a message to a couple of
categories.  Second user navigates tree to see messages about their favourite
topic.

Weekly batch processing adds some reputation points to first and second user.
First user likes second user, awarding some up points, declaring their
appreciation.  Second user awards some down points to first user, declaring
their disgust.  What are their total points?  Another weekly batch run happens.
What are their points?

<PRE>
$Header: /home/agmsmith/Programming/Rating\040Stone/docs/RCS/Database\040Design.md,v 1.10 2020/02/03 22:33:40 agmsmith Exp agmsmith $

$Log: Database\040Design.md,v $
Revision 1.10  2020/02/03 22:33:40  agmsmith
Fix up formatting in kramdown for preformatted code.

Revision 1.9  2020/02/03 22:26:20  agmsmith
Added command lines needed to generate the database.

Revision 1.8  2020/02/02 22:15:24  agmsmith
Added permissions records.

Revision 1.7  2020/02/02 21:44:52  agmsmith
After some experiments, decided to use floating point rating points.

Revision 1.6  2020/01/31 21:54:25  agmsmith
Work in progress adding fields and descriptions, worrying about deleting.

Revision 1.5  2020/01/30 22:16:28  agmsmith
Starting to add fields to the base object record.

Revision 1.4  2020/01/30 15:45:39  agmsmith
Explain the ledger write-once system and single table inheritance.

Revision 1.3  2020/01/30 14:40:09  agmsmith
Writing continues, work in progress.

Revision 1.2  2020/01/29 22:52:13  agmsmith
Fixed up formatting of RCS log and version number.

Revision 1.1  2020/01/29 22:43:07  agmsmith
Initial revision
</PRE>
@


1.10
log
@Fix up formatting in kramdown for preformatted code.
@
text
@d3 3
a5 1
<SMALL>$Id: Database\040Design.md,v 1.9 2020/02/03 22:26:20 agmsmith Exp agmsmith $</SMALL>
d18 2
d21 1
a21 1
later object (they all have datestamps) with the new text and a reference back
d31 2
a32 2
deleted, instead a new link kill record is created, referencing the same two
objects.
d41 2
d51 2
d64 21
d105 1
a105 1
  looking for a specific version the object).
d107 1
a107 1
  not the original record.
d110 15
a124 15
  show a message to the user when an attempt is made to display this object.
  Rating points are accumulated as usual.  That way we can undelete this record
  if needed.
* current_down_points float
* current_meh_points float
* current_up_points float Number of rating points in each of the directions for
  this object.  This is the current total, including fading over time
  (recalculated at the beginning of the week in the awards ceremony) plus new
  ratings applied this week.  We keep the directions seprate to improve
  statistical estimation of how accurate the rating is (just storing the net
  difference of 2 points isn't as meaningful as knowing you had 102 up and 100
  down vs 3 up and 1 down), and use them as inputs to various different sorting
  algorithms.  Until someone redoes the statistical theory, we'll split meh
  points 50% to each of up and down.  But once we have better math, we can use
  meh directly.  When they have all faded away to close to zero (less than
a127 1

d205 1
a205 1
  rating points were used at the beginning of time, before any awards, the
d207 1
a207 1
  points * (fade ** AwardNumber).
d237 2
a238 2
  amending and deleting access, "I" to inherit permissions from some other
  permission record.
d263 3
a265 1
  points and someone else could spend more than they are allowed).
d289 3
a291 2
LedgerDelete record, child is the object being deleted.  If this link object is
deleted, then the LedgerDelete operation is modified to not include child.
d320 2
a321 2
bool1:boolean date1:datetime number1:integer string1:string text1:text
creator:references original:references amended:references
d334 2
a335 1
      t.string :string1, default: "", comment: "Generic string (up to 255 characters), defined by subclasses."
d420 1
a420 1
$Header: /home/agmsmith/Programming/Rating\040Stone/docs/RCS/Database\040Design.md,v 1.9 2020/02/03 22:26:20 agmsmith Exp agmsmith $
d423 3
@


1.9
log
@Added command lines needed to generate the database.
@
text
@d3 1
a3 1
<SMALL>$Id: Database\040Design.md,v 1.8 2020/02/02 22:15:24 agmsmith Exp agmsmith $</SMALL>
d296 1
a296 1
class CreateLedgerBases < ActiveRecord::Migration[6.0]
d316 1
a316 1
end
d319 1
d324 1
d326 1
d332 1
a332 1
class CreateLinkBases < ActiveRecord::Migration[6.0]
d347 1
a347 1
end
d350 1
d353 1
a353 1

d359 1
a359 1
class AddLink1ToLedgerBase < ActiveRecord::Migration[6.0]
d363 1
a363 1
end
d388 1
a388 1
$Header: /home/agmsmith/Programming/Rating\040Stone/docs/RCS/Database\040Design.md,v 1.8 2020/02/02 22:15:24 agmsmith Exp agmsmith $
d391 3
@


1.8
log
@Added permissions records.
@
text
@d3 1
a3 1
<SMALL>$Id: Database\040Design.md,v 1.7 2020/02/02 21:44:52 agmsmith Exp agmsmith $</SMALL>
d57 2
a58 1
## LedgerBase
d68 1
a70 5
* permissions_id Points to the most recent permissions record for this object.
  NULL if everybody is allowed to read it.  Often this will point to a user's
  settings list which contains the default permissions.  For discussion groups,
  it will point to the permission in the group's settings.  Updated when a new
  permissions record is linked to this object.
d100 9
a108 9
**LedgerDelete** < LedgerBase
: Used for marking possibly multiple objects as deleted or killed.
  LinkDelChild records are used to associate this LedgerDelete with all the
  objects being deleted.  Undelete is implemented by creating a new
  LedgerDelete record to kill the original LedgerDelete record, repeat as
  needed to redelete and so on.  We don't support, or even want to think about
  having a LedgerDelete delete itself.  Can have several LedgerDelete records
  deleting the same object; need to kill all those LedgerDelete records to
  undelete that object.
d117 4
a120 3
**LedgerUnlink** < LedgerBase
: Breaks a link, used for removing an object from a list.  You can undo an
  unlink by deleting this LedgerUnlink object.
d125 3
a127 2
**LedgerUser** < LedgerBase
: Idenfities a particular user.
d140 8
a147 8
**LedgerMicropost** < LedgerBase
: A micropost made by a user.  Contains some text in UTF-8 markdown format.
  They can also attach pictures and other media files.  There can also be
  micropost replies, the micropost can be placed in a category list to identify
  what the topic of the text is, have rating points awarded to it, and so on.
  This is the object the user interacts with the most.  It is also usually
  visible to users and even external web sites, unless permissions make it
  private.
d153 7
a159 7
**LedgerMedia** < LedgerBase
: A file uploaded by the user.  Usually some sort of media, like a picture or
  video clip.  Can be attached to microposts to make them more interesting, and
  referenced by external web sites as well.  Byte size only limited by the
  points the user wants to spend to upload it.  All kinds can display a
  picture, which can be clicked on to get more detail or play it if it is a
  video or audio file.
d165 9
a173 8
**LedgerAwardCeremony** < LedgerBase
: This record marks the time when (usually weekly) rating points are awarded.
  We perform the ceremony relative to planetary time, so the actual time
  between ceremonies won't always be exactly 7 days and 0 seconds, due to the
  slowdown of the earth's rotation.  If you delete this record, the ceremony is
  ignored and just about everything needs to be recalculated, including award
  numbers for subsequent ceremonies and LinkBase records.  Currently deleting
  this kind of record is not implemented, so don't do it.
d184 4
a187 3
**LedgerBirthday** < LedgerBase
: Identifies the birthday of a user.  Mostly an excuse to reuse the generic
  timestamp field that LedgerAwardCeremony made necessary.
d193 11
a203 10
**LedgerPermissions** < LedgerBase
: Specifies the permissions needed to access the LedgerObject this record is
  linked to via LinkPermission.  There is a list or even a subtree linked to
  this record specifying a bunch of users in some way (friends of friends etc),
  as specifed by the link record type.  Often this will be a discussion group
  list.  There can be several LedgerPermissions records attached to the same
  object, they are applied in chronological order of link created dates until a
  decision is made.  A LedgerPermissions record can be shared between several
  objects too, such as a default permission for a discussion group applying to
  all microposts and replies in the group.
d214 2
a215 1
## LinkBase
d219 1
a219 4
A is a list header and B is in the list, etc).  Theoretically we don't need
subclasses and could determine the use by examining the object types, but
subclasses and having a type name field in the record is more convenient for
database debugging and sanity checks.
d236 11
a246 8
* rating_points float The number of points spent on making this link by the
  creator.  Over time they are considered to fade (the value in the database
  doesn't change, we just calculate the current faded value when needed), and
  when enough time has gone by, you can remove this link completely from the
  database.  If the child object no longer has any points, it can be deleted
  too, and so on.  We'll probably do that as part of the weekly point updates -
  if the total is near zero (under 0.01, about 3 years of fading for one
  point), the link or object can be deleted.
d256 1
a256 8
**LinkDelChild** < LinkBase
: Identifies an object to be deleted, for use with LedgerDelete.  Parent is the
  LedgerDelete record, child is the object being deleted.  If this link object
  is deleted, then the LedgerDelete operation is modified to not include child.


**LinkReply** < LinkBase
: The child is a reply to the parent.  Usually both objects are LedgerMicropost.
d258 102
a359 14

**LinkMedia** < LinkBase
: The child is some sort of media which should be displayed when the parent is
  shown.  Usually the parent is a LedgerMicropost and the child is a
  LedgerMedia of some type.  We just treat them all as pictures and show them
  in a grid after the text of the micropost.  The user can click on individual
  ones to play them.


**LinkPermission** < LinkBase
: The parent is some LedgerObject, the child is a LedgerPermissions record that
  applies to the parent.  If there are several LinkPermission records for the
  same parent object, they are run through in increasing date of link creation
  until a permission decision is made.
d384 1
a384 1
$Header: /home/agmsmith/Programming/Rating\040Stone/docs/RCS/Database\040Design.md,v 1.7 2020/02/02 21:44:52 agmsmith Exp agmsmith $
d387 3
@


1.7
log
@After some experiments, decided to use floating point rating points.
@
text
@d3 1
a3 1
<SMALL>$Id: Database\040Design.md,v 1.6 2020/01/31 21:54:25 agmsmith Exp agmsmith $</SMALL>
d102 1
d119 1
d126 1
d140 1
d153 1
d165 1
d183 1
d192 20
d252 1
d258 1
d262 1
d271 7
d300 1
a300 1
$Header: /home/agmsmith/Programming/Rating\040Stone/docs/RCS/Database\040Design.md,v 1.6 2020/01/31 21:54:25 agmsmith Exp agmsmith $
d303 3
@


1.6
log
@Work in progress adding fields and descriptions, worrying about deleting.
@
text
@d3 1
a3 1
<SMALL>$Id: Database\040Design.md,v 1.5 2020/01/30 22:16:28 agmsmith Exp agmsmith $</SMALL>
d67 1
a67 1
* creator_id Identifies the user who created this record.  Not NULL; the root
d71 3
a73 3
  settings list which contains the default permissions.  For
  discussion groups, it will point to the permission in the group's settings.
  Updated when a new permissions record is linked to this object.
d87 14
d112 5
a116 5
* killed_too boolean TRUE if the object is killed, false if it is merely
  deleted.  The difference is that all links to a killed object are marked
  deleted too, so the object will no longer be in lists.  The kill flag is
  ignored when deleting a LedgerDelete record - all associated LinkDelete
  records and objects are updated recursively.
d124 60
d195 1
a195 1
  can refer to the link record, really only used when deleting links.
d201 4
a204 3
* deleted_id Points to the LedgerUnlink or LedgerDelete record that deleted
  this record, otherwise NULL (this record is alive).  If this record is
  deleted, the link it made is considered to not exist any more.  Any rating
d209 15
d226 1
a226 1
: Marks an object as deleted, for use with LedgerDelete.  Parent is the
d230 9
a238 3
**LinkDelete** < LinkBase
: Marks a link as deleted.  Parent and child are the same as the object being
  deleted.  If this link object is deleted, then the child is undeleted.
d253 2
a254 1
categories. Second user navigates tree to see messages about their favourite topic.
d263 1
a263 1
$Header: /home/agmsmith/Programming/Rating\040Stone/docs/RCS/Database\040Design.md,v 1.5 2020/01/30 22:16:28 agmsmith Exp agmsmith $
d266 3
@


1.5
log
@Starting to add fields to the base object record.
@
text
@d3 1
a3 1
<SMALL>$Id: Database\040Design.md,v 1.4 2020/01/30 15:45:39 agmsmith Exp agmsmith $</SMALL>
d53 2
a54 1
using the actual database field names whenever we use the subclass object.
d56 4
a59 2
LedgerBase
: The base class for persistent objects that the user may interact with.
d66 1
d71 1
a71 1
  settings list which contains the default permissions, and other things.  For
d82 62
d166 1
a166 1
$Header: /home/agmsmith/Programming/Rating\040Stone/docs/RCS/Database\040Design.md,v 1.4 2020/01/30 15:45:39 agmsmith Exp agmsmith $
d169 3
@


1.4
log
@Explain the ledger write-once system and single table inheritance.
@
text
@d3 1
a3 1
<SMALL>$Id: Database\040Design.md,v 1.3 2020/01/30 14:40:09 agmsmith Exp agmsmith $</SMALL>
d52 2
a53 1
:email_address, :string2".
d56 1
a56 1
: The base class for persistent objects.
d58 40
a97 1
* First field name.
d100 1
a100 1
$Header: /home/agmsmith/Programming/Rating\040Stone/docs/RCS/Database\040Design.md,v 1.3 2020/01/30 14:40:09 agmsmith Exp agmsmith $
d103 3
@


1.3
log
@Writing continues, work in progress.
@
text
@d1 1
a1 1
# The Rating Stone Database
d3 1
a3 1
<SMALL>$Id: Database\040Design.md,v 1.2 2020/01/29 22:52:13 agmsmith Exp agmsmith $</SMALL>
d5 10
a14 3
Because I'm thinking someone could implement the system as a BlockChain ledger
application, or as a federated collection of systems exchanging records, the
database is set up as a mostly read-only collection of objects and linkages.
d18 18
a35 7
to the original text object.  Then when displaying the original text, it will
search for newer versions and display that text.  Of course, advanced users can
view a list of available versions of the text and see the change history.

Similarly when someone adds an item to a list, a link record will be added between the item object's id number and the list object's id number.  To remove an item, the link record isn't deleted, instead a new link kill record is created, with the same id number pair.

Theoretically, when displaying the current state of things, you run through all the records, adding and removing objects and links from the current state.  In practice, we cache things. So an object record would have a flag that marks it as deleted or amended, and a link record would similarly be marked.  Since people might want to reference a deleted thing, we don't actually delete them.
d38 2
a39 2
functionality for various related record types, we're using the Ruby on Rails
ActiveRecord "[single table
d41 12
a52 2
setup.  There will be one table, with a "type" field in each row to specify the
particular subclass used for that row.
d60 1
a60 1
$Header: /home/agmsmith/Programming/Rating\040Stone/docs/RCS/Database\040Design.md,v 1.2 2020/01/29 22:52:13 agmsmith Exp agmsmith $
d63 3
@


1.2
log
@Fixed up formatting of RCS log and version number.
@
text
@d3 1
a3 1
<SMALL>$Id: 1.1 $</SMALL>
d15 4
d32 1
a32 1
$Header: /home/agmsmith/Programming/Rating\040Stone/docs/RCS/Database\040Design.md,v 1.1 2020/01/29 22:43:07 agmsmith Exp agmsmith $
d35 2
@


1.1
log
@Initial revision
@
text
@d3 2
a4 1
$Revision$
d6 1
a6 1
application,  or as a federated collection of systems exchanging records, the
d9 12
a20 4
For example, if you want to edit some posted text, the system will create a later object (they all have datestamps) with the new text and a reference back to the original text object. Then when displaying the original text, it will search for newer versions and display that text.  Of course, advanced users can view a list of available versions of the text and see the change history.

Because I don't want to have zillions of tables, and want to inherit functionality for
various related record types, we're using the Ruby on Rails ActiveRecord "[single table inheritance](https://api.rubyonrails.org/classes/ActiveRecord/Inheritance.html)" setup.   There will be one table, with a "type" field in each row to specify the particular subclass used for that row.
d27 4
a30 2
$Header$
$Log$
d32 3
@
